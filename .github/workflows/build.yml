release:
  needs: build
  if: startsWith(github.ref, 'refs/tags/')
  runs-on: ubuntu-latest

  permissions:
    contents: write # å¿…é¡»æœ‰å†™å…¥æƒé™

  steps:
    - name: â¬‡ï¸ Download All Build Artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: ğŸ”„ Rename Artifacts for Unique Asset Names
      shell: bash
      run: |
        # æ‚¨çš„é‡å‘½åè„šæœ¬ï¼ˆä¿æŒä¸å˜ï¼‰
        for dir_path in artifacts/*; do
          if [ -d "$dir_path" ]; then
            DIR_NAME=$(basename "$dir_path")
            PLATFORM=$(echo "$DIR_NAME" | cut -d'-' -f1) 
        
            for file_path in "$dir_path"/*; do
              if [ -f "$file_path" ]; then
                ORIGINAL_NAME=$(basename "$file_path")
                NEW_NAME="${PLATFORM}_${ORIGINAL_NAME}"
        
                echo "Renaming $ORIGINAL_NAME from $DIR_NAME to artifacts/$NEW_NAME"
                mv "$file_path" "artifacts/$NEW_NAME"
              fi
            done
            rmdir "$dir_path" || true
          fi
        done

    # 1. åˆ›å»º Release ä¸»ä½“ (å®˜æ–¹ Action)
    - name: ğŸ“ Create/Update GitHub Release
      id: create_release
      uses: actions/create-release@v1
      with:
        tag_name: ${{ github.ref }}
        release_name: Automated Release for ${{ github.ref_name }}
        body: |
          Automated Release for **${{ github.ref_name }}**
          ### åŒ…å«çš„å¹³å°
          - Linux (x64)
          - Windows (x64)
        draft: false
        prerelease: false

    # 2. éå† Assets å¹¶ä½¿ç”¨ curl çº¯ API ä¸Šä¼ 
    - name: â¬†ï¸ Upload Release Assets via cURL
      shell: bash
      env:
        # ä½¿ç”¨ GITHUB_TOKEN è¿›è¡Œè®¤è¯
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        UPLOAD_URL="${{ steps.create_release.outputs.upload_url }}"
        # æ›¿æ¢ URL ä¸­çš„ {?name,label} éƒ¨åˆ†ä»¥è·å–çº¯ä¸Šä¼  URL
        CLEAN_URL=$(echo $UPLOAD_URL | sed 's/{?name,label}//')
        
        # éå†æ‰€æœ‰é‡å‘½ååçš„æ–‡ä»¶
        for ASSET_PATH in artifacts/*; do
          if [ -f "$ASSET_PATH" ]; then
            ASSET_NAME=$(basename "$ASSET_PATH")
        
            echo "Uploading $ASSET_NAME to $CLEAN_URL..."
        
            # ä½¿ç”¨ cURL è°ƒç”¨ GitHub Upload APIã€‚
            # &overwrite=true å‚æ•°ä¿è¯è¦†ç›–åŒåæ–‡ä»¶ï¼Œæ— éœ€ä»»ä½•åˆ é™¤é€»è¾‘ã€‚
            curl -X POST "$CLEAN_URL?name=$ASSET_NAME&overwrite=true" \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Content-Type: application/octet-stream" \
              --data-binary "@$ASSET_PATH"
        
            # æ£€æŸ¥ cURL é€€å‡ºçŠ¶æ€ç ï¼Œç¡®ä¿ä¸Šä¼ æˆåŠŸï¼Œä½†æˆ‘ä»¬ä¸ä¼šå›  API å†…éƒ¨é”™è¯¯è€Œå¤±è´¥
            if [ $? -ne 0 ]; then
              echo "Warning: cURL upload of $ASSET_NAME failed, but proceeding..."
            fi
          fi
        done