name: Wails build

# ä»…åœ¨æ‰“ Tag æ—¶è§¦å‘æ„å»º
on:
  push:
    tags:
      - '*' # åŒ¹é…ä»»ä½•æ–° Tag

# ç¯å¢ƒå˜é‡ï¼šå¢åŠ å†…å­˜é™åˆ¶ï¼Œé¿å… OOM
env:
  NODE_OPTIONS: "--max-old-space-size=4096"

jobs:
  build:
    strategy:
      # ä»»ä½•å¹³å°æ„å»ºå¤±è´¥éƒ½ä¸ä¼šå½±å“å…¶ä»–å¹³å°çš„æ„å»º
      fail-fast: false
      matrix:
        build:
          - name: 'Linux'
            platform: 'linux/amd64'
            os: 'ubuntu-latest'
          - name: 'Windows'
            platform: 'windows/amd64'
            os: 'windows-latest'
          # æ–°å¢ macOS æ„å»º
          - name: 'macOS'
            platform: 'darwin/universal'
            os: 'macos-latest'

    runs-on: ${{ matrix.build.os }}

    steps:
      - name: âš™ï¸ Checkout Repository
        # ä½¿ç”¨ v4 ç¨³å®šç‰ˆæœ¬
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ğŸ”¨ Build Wails App (${{ matrix.build.name }})
        # å»ºè®®ä½¿ç”¨ v2.2 ç¨³å®šç‰ˆæœ¬
        uses: dAppServer/wails-build-action@v2.2
        id: build
        with:
          # ä½¿ç”¨ä¸€ä¸ªç»Ÿä¸€çš„åº”ç”¨åï¼ŒWails ä¼šè‡ªåŠ¨æ·»åŠ å¹³å°åç¼€
          build-name: 'Go_Arknights_Gacha_App'
          build-platform: ${{ matrix.build.platform }}
          # æ‚¨çš„éœ€æ±‚æ˜¯å‘å¸ƒ Releaseï¼Œæ‰€ä»¥ package åº”è¯¥è®¾ç½®ä¸º true
          package: true
          go-version: '1.23' # ä¿æŒæ‚¨çš„ Go ç‰ˆæœ¬

      - name: ğŸ“¦ Upload Build Artifact
        # å°†æ„å»ºç»“æœä½œä¸º Artifact ä¸Šä¼ ï¼Œä»¥ä¾¿ Release æ­¥éª¤ä½¿ç”¨
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.build.name }}-build
          path: build/bin/*
          # ä»…ä¿ç•™äº§ç‰©ä¸€å¤©ï¼Œé¿å…å ç”¨è¿‡å¤šç©ºé—´
          retention-days: 1

  release:
    # ä»…åœ¨ build ä»»åŠ¡å®Œæˆåæ‰§è¡Œ
    needs: build
    # ä»…åœ¨ Tag Push è§¦å‘æ—¶æ‰§è¡Œ
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Download All Build Artifacts
        # ä¸‹è½½ä¸Šä¸€æ­¥ä¸­æ‰€æœ‰å¹³å°çš„æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ğŸš€ Create GitHub Release
        # ä½¿ç”¨ v2 ç¨³å®šç‰ˆæœ¬
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/* # åŒ¹é…ä¸‹è½½ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
          body: |
            Automated Release for **${{ github.ref_name }}**

            ### Changes
            
            # (åœ¨æ­¤å¤„å¯ä»¥æ·»åŠ æ›´è¯¦ç»†çš„ Release Notes)

          # ç¡®ä¿æœ‰æƒé™ä¸Šä¼ æ–‡ä»¶
          token: ${{ secrets.GITHUB_TOKEN }}