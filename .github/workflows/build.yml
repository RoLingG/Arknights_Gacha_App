name: Wails build

# ä»…åœ¨æ‰“ Tag æ—¶è§¦å‘æ„å»º
on:
  push:
    tags:
      - '*' # åŒ¹é…ä»»ä½•æ–° Tag

# ç¯å¢ƒå˜é‡ï¼šå¢åŠ å†…å­˜é™åˆ¶ï¼Œé¿å… OOM
env:
  NODE_OPTIONS: "--max-old-space-size=4096"

jobs:
  build:
    strategy:
      # ä»»ä½•å¹³å°æ„å»ºå¤±è´¥éƒ½ä¸ä¼šå½±å“å…¶ä»–å¹³å°çš„æ„å»º
      fail-fast: false
      matrix:
        build:
          - name: 'Linux'
            platform: 'linux/amd64'
            os: 'ubuntu-latest'
          - name: 'Windows'
            platform: 'windows/amd64'
            os: 'windows-latest'

    runs-on: ${{ matrix.build.os }}

    steps:
      - name: âš™ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ğŸ”¨ Build Wails App (${{ matrix.build.name }})
        # ã€å…³é”®ç‚¹ã€‘æ ¹æ®æ‚¨çš„ç»éªŒï¼Œä½¿ç”¨ @main ç¡®ä¿è·å¾—æœ€æ–°çš„ä¾èµ–ä¿®å¤
        uses: dAppServer/wails-build-action@main
        id: build
        with:
          # ä½¿ç”¨ä¸€ä¸ªç»Ÿä¸€çš„åº”ç”¨åï¼ŒWails ä¼šè‡ªåŠ¨æ·»åŠ å¹³å°åç¼€
          build-name: 'Go_Arknights_Gacha_App'
          build-platform: ${{ matrix.build.platform }}
          package: true
          go-version: '1.23'

      - name: ğŸ“¦ Upload Build Artifact
        # ä½¿ç”¨ v4 ç¨³å®šç‰ˆæœ¬ä¸Šä¼  Artifact
        uses: actions/upload-artifact@v4
        with:
          # ä½¿ç”¨ matrix.build.name ä½œä¸º Artifact åç§°
          name: ${{ matrix.build.name }}-build
          path: build/bin/*
          retention-days: 1

  release:
    # ä»…åœ¨ build ä»»åŠ¡å®Œæˆåæ‰§è¡Œ
    needs: build
    # ä»…åœ¨ Tag Push è§¦å‘æ—¶æ‰§è¡Œ
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: â¬‡ï¸ Download All Build Artifacts
        # ä½¿ç”¨ v4 ç¨³å®šç‰ˆæœ¬ä¸‹è½½ Artifact
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ğŸ”„ Rename Artifacts for Unique Asset Names
        shell: bash
        run: |
          # éå† artifacts ç›®å½•ä¸‹çš„æ‰€æœ‰ Artifact æ–‡ä»¶å¤¹ (e.g., Linux-build, Windows-build)
          for dir_path in artifacts/*; do
            # ç¡®ä¿è¿™æ˜¯ä¸€ä¸ªç›®å½•
            if [ -d "$dir_path" ]; then
              # è·å– Artifact æ–‡ä»¶å¤¹å (e.g., Linux-build)
              DIR_NAME=$(basename "$dir_path")
              # æå–å¹³å°å (e.g., Linux-build -> Linux)
              # ä½¿ç”¨ cut å‘½ä»¤ä»£æ›¿ sedï¼Œæ›´ç®€æ´
              PLATFORM=$(echo "$DIR_NAME" | cut -d'-' -f1) 
          
              # éå†è¯¥ Artifact æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
              # é»˜è®¤æƒ…å†µä¸‹ï¼Œwails-build-action ç”Ÿæˆçš„æ–‡ä»¶å°±åœ¨è¿™é‡Œï¼Œ
              # å› ä¸º upload-artifact çš„ path æ˜¯ build/bin/*
              # å¦‚æœ Wails ç”Ÿæˆäº†å­ç›®å½•ï¼Œè¯·ä½¿ç”¨ "$dir_path"/*/* é€’å½’æŸ¥æ‰¾
              for file_path in "$dir_path"/*; do
                if [ -f "$file_path" ]; then
                  # è·å–åŸå§‹æ–‡ä»¶å (e.g., Go_Arknights_Gacha_App.exe)
                  ORIGINAL_NAME=$(basename "$file_path")
          
                  # æ„é€ æ–°çš„å”¯ä¸€æ–‡ä»¶å
                  NEW_NAME="${PLATFORM}_${ORIGINAL_NAME}"
          
                  echo "Renaming $ORIGINAL_NAME from $DIR_NAME to artifacts/$NEW_NAME"
                  # ç§»åŠ¨å¹¶é‡å‘½ååˆ° artifacts æ ¹ç›®å½•
                  mv "$file_path" "artifacts/$NEW_NAME"
                fi
              done
              # æ¸…ç†ç©ºçš„ Artifact ç›®å½•
              rmdir "$dir_path" || true
            fi
          done

      # 1. åˆ›å»º Release å¹¶è·å– Release ID
      - name: ğŸ“ Create/Update GitHub Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ github.ref }}
          release_name: Automated Release for ${{ github.ref_name }}
          body: |
            Automated Release for **${{ github.ref_name }}**

            ### åŒ…å«çš„å¹³å°
            - Linux (x64)
            - Windows (x64)
          draft: false
          prerelease: false

      # 2. éå† Artifacts å¹¶é€ä¸ªä¸Šä¼ 
      # ä½¿ç”¨å®˜æ–¹ Action actions/upload-release-asset@v1
      - name: â¬†ï¸ Upload Release Assets
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: artifacts/* # åŒ¹é…æ‰€æœ‰é‡å‘½ååçš„å”¯ä¸€æ–‡ä»¶
          asset_name: $(basename ${{ github.workspace }}/artifacts/*) # æ­¤è¡Œéœ€è¦é…åˆ Bash å¾ªç¯æ›¿æ¢
          asset_content_type: ''

        # ä¸ºäº†æ›´å¥å£®ï¼Œæˆ‘ä»¬ä½¿ç”¨ Bash å¾ªç¯é€ä¸ªè°ƒç”¨ upload-release-asset
        run: |
          UPLOAD_URL="${{ steps.create_release.outputs.upload_url }}"
          
          # éå†æ‰€æœ‰é‡å‘½ååçš„æ–‡ä»¶
          for ASSET_PATH in artifacts/*; do
            if [ -f "$ASSET_PATH" ]; then
              ASSET_NAME=$(basename "$ASSET_PATH")
          
              echo "Uploading $ASSET_NAME..."
          
              # è°ƒç”¨ upload-release-asset çš„æ ¸å¿ƒé€»è¾‘ï¼ˆä½¿ç”¨ curlï¼‰
              /usr/bin/curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Content-Type: application/octet-stream" \
                --data-binary "@$ASSET_PATH" \
                "$UPLOAD_URL?name=$ASSET_NAME&overwrite=true"
            fi
          done